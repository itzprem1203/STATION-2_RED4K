<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Login Page</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="{% static 'bootstrap-5.3.3-dist/css/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'fontawesome-free-6.7.2-web/css/all.min.css' %}">

</head>
<style>
    .alert-center {
        position: fixed;
        top: 10%;
        left: 45%;
        height: 30%;
        width: 60%;
        transform: translate(-50%, -50%);
        z-index: 1000;
        display: none;
        text-align: center;
    }
    #clock-box{
         background-color:white;
         border-radius: 5px;
         height: 10%;
         border: 1px solid black;
         padding-top: 2%;
         font-weight: bold;
         max-width: 15%;
         margin-left: 40%;
 
        }

     


html, body{
    margin: 0;
    padding: 0;
    overflow: hidden;
    height: 100vh;
    width: 100vw;
  background-color: lightgrey;
 
}
body{
    border: 8px double black; 
}

.main_login{
    height: 100%;
    width: 100%;
  
   
}
.first_container{
    display: flex;
}

.second_container{
    display: flex;
}
.third_container{
    display: flex;  
}

.image_container {
    width: 35vw;
    height: 39vh;
    background-color: red;
    border: 2px solid black;
    overflow: hidden; /* optional: hides anything outside the container */
    display: flex;
    margin-top: 3%;
    margin-left: 2%;
    border-radius: 10px;
}

.image_container img {
    width: 100%;
    height: 100%;
    object-fit: cover; /* or use 'cover' depending on your need */
}






.login {
    width: 30vw;
    min-width: 300px;
    height: 39vh;
    margin-top: 3%;
    margin-left: 28%;
    background-color: gray;
    border: 2px solid black;
    border-radius: 10px;
    padding: 1rem;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
}



#heading {
    font-weight: bold;
    font-size: 2vw;
    margin-bottom: 5%;
    margin-top: 1%;
    display: block;
    text-align: center;
    color: white;
}

.tbox {
    display: flex;
    align-items: center;
    background-color: white;
    border-radius: 5px;
    width: 80%;
    margin-left: 10%;
  
}

.tbox input {
    flex: 1;
    border: none;
    outline: none;
    padding: 0.5rem;
    font-size: 1.2vw;
    width: 80%;
}

.password-input-container {
    display: flex;
    align-items: center;
    width: 100%;
}

.toggle-password {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1.2rem;
    margin-left: auto;
}

#login-button {
    width: 40%;
    padding: 0.75rem;
    background-color:red;
    color: white;
    font-size: 1rem;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    margin-left: 50%;
    font-size: 1.2vw;
}

#login-button:hover {
    background-color: rgb(247, 79, 79);
}

.center-align {
    text-align: center;
    margin-left: 25%;
    color: darkorange;
    font-size: 4vw;
    margin-top: 2%;
    font-weight: bold;
    text-shadow: 2px 2px 4px #000000;
    font-family: apple-system;
    font-style: italic;
}


.right-align {
    text-align: right;
    font-size: 2.5vw;
   margin-right: 2%;
   font-weight: 600;
    color:aqua;
    text-shadow: 2px 2px 4px #000000;
}



.left-align {
    text-align: left;
    font-size: 2vw;
    font-family: 'Times New Roman', Times, serif;
    margin-top: 3%;
    margin-left: 5%;
    color: black;
}

.right-align-1{
    text-align: right;
    font-size: 2vw;
   font-family: 'Times New Roman', Times, serif;
    margin-top: 3%;
    margin-left: 40%;
    color: black;
}

#close{
            width: 90%;
            background-color: lightslategray;
            text-align: center;
           margin-bottom: 2%;
            font-weight: bold;
            font-size: 2vw;
            margin-left: 5%;
            color: white;
            font-family: Cambria, Cochin, Georgia, Times, 'Times New Roman', serif;

        }
      
</style>
<body>
<div class="main_login">
    <div class="first_container">
    <div class="image_container">
        
        <img src="{% static 'images/Gauge.jpg' %}">
    </div>
   
   <div class="login">
        <div class="loginform">
           <label id="heading">LOGIN</label>
            <form method="post" id="login-form">
                {% csrf_token %}
                <div class="tbox">
                    <i class="fa fa-user mx-3"></i>
                    <input type="text" name="user" id="username" placeholder="Username" autocomplete="off" required>
                </div>
                <br>
                <div class="tbox">
                    <div class="password-input-container">
                        <i class="fa fa-lock mx-3"></i>
                        <input type="password" name="password" id="password" placeholder="Password" class="password-input" autocomplete="off" required>
                        <button type="button" class="toggle-password" onclick="togglePasswordVisibility()">üëÅ</button>
                    </div>
                </div>
                <br>
                
                <button type="submit" id="login-button"><b>Login</b></button>
            </form>
            {% if error_message %}
            <div class="alert alert-danger alert-center" role="alert" id="error-alert">
                {{ error_message }}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<div class="second_container">
    <div class="center-align">
        GAUGE LOGIC DAQ - SPC
    </div>
    
</div>

<div class="second_container1">
   
    <div class="right-align">
        -Accuracy is Our Moto & Passion
    </div>
</div>
 

<div class="third_container">
    <div class="left-align">
        Web: www.gaugelogic.com<br>E-Mail: sales@gaugelogic.com
    </div>
    <div class="right-align-1">
        Sales : +91 7448411234
    </div>
</div>

 

    <div class="box" id="clock-box" hidden></div>

    <div style="margin-left: 800px; margin-top: 20px;">
        <input id="back_date" type="text" value=" {{ backup_date }}" hidden>
        <input id="confirm" type="text" value=" {{ confirm_backup }}" hidden>
        <input id="idValue" type="text" value=" {{ id }}" hidden>
    </div>
    
    <textarea id="serial-data-display" cols="50" rows="10" readonly hidden></textarea>

    <button id="close" onclick="closeApp()">Close</button>
</div>

    <!-- <input type="text" id="db_port" value="{{ comport_com_port }}" >
    <input type="text" id="com_ports" value="{{ ports_string }}" >
    <input type="text" id="baud_rate" value="{{ comport_baud_rate }}" >
    <input type="text" id="parity" value="{{ comport_parity }}" >
    <input type="text" id="stopbit" value="{{ comport_stopbit }}" >
    <input type="text" id="databit" value="{{ comport_databit }}" > -->

    <script>


function closeApp() {
    window.pywebview.api.shutdown();  // Call the shutdown function
}



// document.addEventListener('DOMContentLoaded', function() {
//     let socket = new WebSocket('ws://localhost:8000/ws/measurement/');

//     socket.onopen = function() {
//         console.log("‚úÖ WebSocket Connected!");

//         let card = "PLC";  
//         let com_port = document.getElementById("db_port").value;
//         let baud_rate = parseInt(document.getElementById("baud_rate").value, 10);
//         let databit = parseInt(document.getElementById("databit").value, 10);
//         let stopbit = parseFloat(document.getElementById("stopbit").value);
//         let parity = document.getElementById("parity").value;

//         if (!com_port || !baud_rate || !databit || !stopbit || !parity) {
//             console.error("‚ö†Ô∏è Missing PLC connection parameters.");
//             return;
//         }

//         // Start PLC connection
//         socket.send(JSON.stringify({ 
//             "command": "start_PLC",
//             "card": card,
//             "com_port": com_port,
//             "baud_rate": baud_rate,
//             "databit": databit,
//             "stopbit": stopbit,
//             "parity": parity
//         }));

//         // Start reading and writing continuously
//         setInterval(() => {
//             socket.send(JSON.stringify({ "action": "write", "address": 4100, "value": 1 }));
//         }, 1000);
        
//         setInterval(() => {
            
//             socket.send(JSON.stringify({ "action": "read", "address": 4105 }));
//         }, 1000);
//     };

//     socket.onmessage = function(event) {
//         let response = JSON.parse(event.data);

//         if (response.status === "success") {
//             console.log("‚úÖ PLC Response:", response);
//         } else {
//             console.error("‚ö†Ô∏è Error:", response.message);
//         }

//         if (response.address === 4105) {
//             console.log("üì° Value from 4106:", response.value);
//         }
//     };

//     socket.onerror = function(error) {
//         console.error("‚ùå WebSocket Error:", error);
//     };

//     socket.onclose = function() {
//         console.log("üî¥ WebSocket Closed");
//     };
// });





///////////////////////////////////////////////////////////////////
let alertShown = false; // Track if the alert has been shown

function updateClock() {
    var id_value = document.getElementById("idValue").value.trim();
    var backupDateStr = document.getElementById("back_date").value.trim();
    var confirmValue = document.getElementById("confirm").value.trim();
    var currentDate = new Date();

    // Display current date and time in the clock box
    var hours = currentDate.getHours();
    var minutes = currentDate.getMinutes();
    var seconds = currentDate.getSeconds();
    var ampm = hours >= 12 ? 'PM' : 'AM';
    hours = hours % 12;
    hours = hours ? hours : 12; // Handle midnight (0 hours)
    minutes = minutes < 10 ? '0' + minutes : minutes;
    seconds = seconds < 10 ? '0' + seconds : seconds;
    var currentTime = hours + ':' + minutes + ':' + seconds + ' ' + ampm;
    var day = currentDate.getDate();
    var month = currentDate.getMonth() + 1; // Month is zero-based
    var year = currentDate.getFullYear();
    var currentDateFormatted = day + '-' + month + '-' + year + ' ' + currentTime;
    document.getElementById("clock-box").innerHTML = currentDateFormatted;

    // Parse the backup date string (format: dd-mm-yyyy hh:mm:ss AM/PM)
    var [backupDay, backupMonth, backupYearAndTime] = backupDateStr.split('-');
    var [backupYear, backupTime] = backupYearAndTime.split(' ');
    var [backupHourMinSec, backupAmPm] = backupTime.split(' ');
    var [backupHours, backupMinutes, backupSeconds] = backupHourMinSec.split(':');

    // Convert the backup date and time to a Date object
    backupHours = parseInt(backupHours);
    if (backupAmPm === 'PM' && backupHours < 12) backupHours += 12; // Adjust for PM
    if (backupAmPm === 'AM' && backupHours === 12) backupHours = 0; // Handle midnight (12 AM)

    var backupDate = new Date(
        parseInt(backupYear), 
        parseInt(backupMonth) - 1, 
        parseInt(backupDay),
        backupHours,
        parseInt(backupMinutes),
        parseInt(backupSeconds)
    );

    // If current date is greater than or equal to backup date and confirm value is 'False'
    if (currentDate >= backupDate && confirmValue === 'False' && !alertShown) {
        // Display the custom alert message
        alert("The backup date and time have been reached!");

        confirmValue = 'True';
        document.getElementById("confirm").value = confirmValue; // Update the DOM element if needed
        alertShown = true; // Set alertShown to true to prevent future alerts

        // Send confirmValue and backupDate to the Django view
        sendDataToBackend(confirmValue, backupDateStr, id_value);
    }

    // Call this function again after 1 second
    setTimeout(updateClock, 1000);
}

// Optional: Event listener to reset alertShown when the confirm value is updated
document.getElementById("confirm").addEventListener('change', function() {
    if (this.value === 'True') {
        alertShown = false; // Reset alertShown if confirmation changes
    }
});

// Start the clock
updateClock();


function sendDataToBackend(confirmValue, backupDate, id_value) {
    // console.log('Sending Data:', {
    //     confirm: confirmValue,
    //     backup_date: backupDate,
    //     idValue: id_value,
    // });
    
    fetch('/backup/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken') // Ensure CSRF token is sent for security
        },
        body: JSON.stringify({
            confirm: confirmValue,
            backup_date: backupDate,
            idValue: id_value,
        })
    })
    .then(response => {
        return response.json(); // Parse the JSON response
    })
    .then(data => {
        if (data.status === 'success') {
            // console.log('Backup completed successfully!');
            displayNotification(data.message, 'success'); // Show success message
        } else {
            // console.error('Backup failed');
            displayNotification(data.message, 'error'); // Show error message
        }
    })
    .catch(error => {
        console.error('Error sending data:', error);
        displayNotification('An error occurred while sending data.', 'error'); // Show error if fetch fails
    });
}

function displayNotification(message, type) {
    const notification = document.getElementById('notification');
    
    // Set the notification message and style based on the type ('success' or 'error')
    notification.innerHTML = message;
    if (type === 'success') {
        notification.style.backgroundColor = 'green';  // Green background for success
    } else {
        notification.style.backgroundColor = 'red';    // Red background for error
    }
    
    // Show the notification
    notification.style.display = 'block';

    // Hide the notification after 5 seconds
    setTimeout(() => {
        notification.style.display = 'none';
    }, 5000);
}

// Function to get the CSRF token for Django
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            // Check if this cookie string begins with the name we want
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Call the function when the page loads
window.onload = function() {
    updateClock(); // Start the clock display
};




        function togglePasswordVisibility() {
            var passwordInput = document.querySelector('.password-input');
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
            } else {
                passwordInput.type = 'password';
            }
        }
    
        // Function to update the current date and time on the page
// Function to update the current date and time on the page


    
        document.addEventListener("DOMContentLoaded", function() {
            var errorAlert = document.getElementById('error-alert');
            if (errorAlert) {
                errorAlert.style.display = 'block';
                setTimeout(function() {
                    errorAlert.style.display = 'none';
                }, 3000); // Hide after 3 seconds
            }
        });
    
        window.addEventListener('DOMContentLoaded', (event) => {
            var inputs = document.querySelectorAll('input');
            inputs.forEach(input => {
                input.setAttribute('autocomplete', 'off');
            });
        });
    </script>
    
    
    
</body>
</html>
